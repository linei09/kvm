#cloud-config
hostname: 4
manage_etc_hosts: true
users:
  - name: a
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/a
    shell: /bin/bash
    lock_passwd: false
ssh_pwauth: true
disable_root: false
chpasswd:
  list: |
    a:a
  expire: false

packages:
  - build-essential
  - libpcre3
  - libpcre3-dev
  - libssl-dev
  - zlib1g-dev
  - wget
  - tar
  - make
  - gcc
  - systemd
  - libexpat1-dev


runcmd:
  # Chuyển vào thư mục /home/a để tải và cài đặt Apache
  - cd /home/a

  # Tải và giải nén Apache HTTP Server 2.4.50
  - wget https://archive.apache.org/dist/httpd/httpd-2.4.50.tar.gz
  - tar -xzvf httpd-2.4.50.tar.gz
  - cd httpd-2.4.50/srclib

  # Tải APR và APR-Util
  - wget https://archive.apache.org/dist/apr/apr-1.7.0.tar.gz
  - tar -xvzf apr-1.7.0.tar.gz
  - mv apr-1.7.0 apr
  - wget https://archive.apache.org/dist/apr/apr-util-1.6.1.tar.gz
  - tar -xvzf apr-util-1.6.1.tar.gz
  - mv apr-util-1.6.1 apr-util

  # Quay lại thư mục gốc Apache
  - cd /home/a/httpd-2.4.50

  # Cấu hình và biên dịch Apache
  - ./configure --enable-so --enable-cgi --with-included-apr --enable-rewrite --enable-ssl --enable-mods-shared=all
  - make
  - sudo make install

  # Tạo file cấu hình systemd cho Apache
  - |
    cat <<EOF | sudo tee /etc/systemd/system/apache-custom.service
    [Unit]
    Description=The Apache HTTP Server
    After=network.target

    [Service]
    Type=forking
    ExecStart=/usr/local/apache2/bin/apachectl start
    ExecReload=/usr/local/apache2/bin/apachectl graceful
    ExecStop=/usr/local/apache2/bin/apachectl stop
    PIDFile=/usr/local/apache2/logs/httpd.pid
    PrivateTmp=true

    [Install]
    WantedBy=multi-user.target
    EOF

  # Tải lại systemd và khởi động Apache dưới dạng service
  - sudo systemctl daemon-reload
  - sudo systemctl start apache-custom
  - sudo systemctl enable apache-custom

  # Cấu hình Apache cho Path Traversal và CGI
  - |
    sudo sed -i '/<Directory "\/usr\/local\/apache2\/htdocs">/,/<\/Directory>/c\<Directory "/usr/local/apache2/htdocs">\n    AllowOverride None\n    Require all granted\n<\/Directory>' /usr/local/apache2/conf/httpd.conf
  - |
    sudo sed -i '/<Directory "\/usr\/local\/apache2\/cgi-bin\/">/,/<\/Directory>/c\<Directory "/usr/local/apache2/cgi-bin/">\n    AllowOverride None\n    Options +ExecCGI\n    Require all granted\n<\/Directory>' /usr/local/apache2/conf/httpd.conf

  # Cấp quyền thực thi cho thư mục CGI và các script trong đó
  - sudo chmod +x /usr/local/apache2/cgi-bin/
  - sudo chmod -R +x /usr/local/apache2/cgi-bin/*

  # Khởi động lại Apache để áp dụng cấu hình mới
  - sudo systemctl restart apache-custom

final_message: "Apache 2.4.50 installed and configured as a service. Path Traversal, CGI enabled, and permissions applied."
