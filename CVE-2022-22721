#cloud-config
hostname: ubuntu18
manage_etc_hosts: true
users:
  - name: a
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/a
    shell: /bin/bash
    lock_passwd: false
ssh_pwauth: true
disable_root: false
chpasswd:
  list: |
    a:a
  expire: false
package_update: true
package_upgrade: true
packages:
  - apache2
  - php
  - libapache2-mod-php
  - php-mysql
  - mariadb-server
  - wget
  - unzip
  - build-essential
  - wget
  - tar
  - libpcre3-dev
  - libapr1-dev
  - libaprutil1-dev


runcmd:
  # 1. Tạo thư mục làm việc
  - mkdir -p /home/ubuntu/cve-2022-22721
  - cd /home/ubuntu/cve-2022-22721

  # 2. Tải mã nguồn Apache 2.4.52
  - wget https://archive.apache.org/dist/httpd/httpd-2.4.52.tar.gz
  - tar -xzf httpd-2.4.52.tar.gz
  - cd httpd-2.4.52/srclib

  # 3. Tải APR và APR-util
  - wget https://archive.apache.org/dist/apr/apr-1.7.0.tar.gz
  - wget https://archive.apache.org/dist/apr/apr-util-1.6.1.tar.gz
  - tar -xzf apr-1.7.0.tar.gz
  - tar -xzf apr-util-1.6.1.tar.gz

  # 4. Đổi tên thư mục APR và APR-util
  - mv apr-1.7.0 apr
  - mv apr-util-1.6.1 apr-util

  # 5. Quay lại thư mục Apache và cấu hình
  - cd /home/ubuntu/cve-2022-22721/httpd-2.4.52
  - ./configure --prefix=/home/ubuntu/apache_vulnerable --enable-mods-shared=all --with-included-apr

  # 6. Biên dịch và cài đặt
  - make
  - make install
  sudo groupadd www-data
  sudo useradd -r -g www-data www-data
  sudo chown -R www-data:www-data /home/ubuntu/apache_vulnerable/htdocs
  sudo chmod -R 755 /home/ubuntu/apache_vulnerable/htdocs

  # 7. Tạo file cấu hình Apache đơn giản
  - cat  > /home/ubuntu/apache_vulnerable/conf/httpd.conf <<EOF
	# Server Root Directory
	ServerRoot "/home/ubuntu/apache_vulnerable"

	# Listen on port 8080
	Listen 8080

	# Server Name
	ServerName localhost

	# Document Root
	DocumentRoot "/home/ubuntu/apache_vulnerable/htdocs"
	<Directory "/home/ubuntu/apache_vulnerable/htdocs">
		AllowOverride None
		Require all granted
		<Limit POST>
			Require all granted
		</Limit>
	</Directory>

	# Allow handling large requests (set high value to trigger integer overflow)
	LimitXMLRequestBody 2147483647


	# Logging
	ErrorLog "/home/ubuntu/apache_vulnerable/logs/error_log"
	LogLevel debug

	# Modules to Load
	#LoadModule mpm_event_module modules/mod_mpm_event.so
	LoadModule unixd_module modules/mod_unixd.so
	LoadModule authz_core_module modules/mod_authz_core.so
	LoadModule request_module modules/mod_request.so

	# User and Group
	User www-data
	Group www-data

	# Directory Index
	<IfModule dir_module>
		DirectoryIndex index.html
	</IfModule>


    EOF

  # 8. Khởi động Apache
  - /home/ubuntu/apache_vulnerable/bin/httpd -k start
