#cloud-config
hostname: ubuntu18
manage_etc_hosts: true
users:
  - name: a
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/a
    shell: /bin/bash
    lock_passwd: false
ssh_pwauth: true
disable_root: false
chpasswd:
  list: |
    a:a
  expire: false
package_update: true
package_upgrade: true
packages:
  - apache2
  - php
  - libapache2-mod-php
  - php-mysql
  - mariadb-server
  - wget
  - unzip
  - build-essential
  - wget
  - tar
  - libpcre3-dev
  - libapr1-dev
  - libaprutil1-dev


runcmd:
  # 1. Tạo thư mục làm việc
  - mkdir -p /home/ubuntu/cve-2022-22721
  - cd /home/ubuntu/cve-2022-22721

  # 2. Tải mã nguồn Apache 2.4.52
  - wget https://archive.apache.org/dist/httpd/httpd-2.4.52.tar.gz
  - tar -xzf httpd-2.4.52.tar.gz
  - cd httpd-2.4.52/srclib

  # 3. Tải APR và APR-util
  - wget https://archive.apache.org/dist/apr/apr-1.7.0.tar.gz
  - wget https://archive.apache.org/dist/apr/apr-util-1.6.1.tar.gz
  - tar -xzf apr-1.7.0.tar.gz
  - tar -xzf apr-util-1.6.1.tar.gz

  # 4. Đổi tên thư mục APR và APR-util
  - mv apr-1.7.0 apr
  - mv apr-util-1.6.1 apr-util

  # 5. Quay lại thư mục Apache và cấu hình
  - cd /home/ubuntu/cve-2022-22721/httpd-2.4.52
  - ./configure --prefix=/home/ubuntu/apache_vulnerable --enable-mods-shared=all --with-included-apr

  # 6. Biên dịch và cài đặt
  - make
  - make install

  # 7. Tạo file cấu hình Apache đơn giản
  - cat <<EOF > /home/ubuntu/apache_vulnerable/conf/httpd.conf
    ServerRoot "/home/ubuntu/apache_vulnerable"
    Listen 8080
    DocumentRoot "/home/ubuntu/apache_vulnerable/htdocs"
    <Directory "/home/ubuntu/apache_vulnerable/htdocs">
        AllowOverride None
        Require all granted
    </Directory>
    LimitXMLRequestBody 400000000
    ErrorLog "/home/ubuntu/apache_vulnerable/logs/error_log"
    LogLevel debug
    EOF

  # 8. Khởi động Apache
  - /home/ubuntu/apache_vulnerable/bin/httpd -k start
