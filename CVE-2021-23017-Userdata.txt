#cloud-config
hostname: vm01
manage_etc_hosts: true
users:
  - name: a
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/a
    shell: /bin/bash
    lock_passwd: false
ssh_pwauth: true
disable_root: false
chpasswd:
  list: |
    a:a
  expire: false
 
package_update: true
package_upgrade: true

# Install dependencies for building NGINX from source
packages:
  - build-essential
  - libpcre3
  - libpcre3-dev
  - zlib1g
  - zlib1g-dev
  - libssl-dev
  - wget

runcmd:
  # Step 1: Download and extract NGINX 1.20.1 (vulnerable version)
  - wget http://nginx.org/download/nginx-1.20.1.tar.gz
  - tar -zxvf nginx-1.20.1.tar.gz
  - cd nginx-1.20.1
  
  # Step 2: Export CFLAGS to bypass deprecated OpenSSL 3.0 functions
  - export CFLAGS="-Wno-error=deprecated-declarations"
  
  # Step 3: Configure, build, and install NGINX
  - ./configure --with-http_ssl_module
  - make
  - make install

  # Step 4: Create systemd service file for NGINX
  - |
    cat <<EOF > /etc/systemd/system/nginx.service
    [Unit]
    Description=The NGINX HTTP and reverse proxy server
    After=network.target

    [Service]
    ExecStart=/usr/local/nginx/sbin/nginx -g 'daemon off;'
    ExecReload=/usr/local/nginx/sbin/nginx -s reload
    ExecStop=/usr/local/nginx/sbin/nginx -s stop
    PIDFile=/usr/local/nginx/logs/nginx.pid
    Restart=on-failure
    RestartSec=5

    [Install]
    WantedBy=multi-user.target
    EOF

  # Step 5: Ensure correct permissions and ownership for NGINX directories
  # Use 'www-data' as user/group instead of 'nobody'
  - sudo chown -R www-data:www-data /usr/local/nginx
  - sudo chmod -R 755 /usr/local/nginx

  # Step 6: Reload systemd and start NGINX service
  - systemctl daemon-reload
  - systemctl enable nginx
  - systemctl start nginx

# Step 7: Write a basic NGINX configuration with a resolver to make the system vulnerable to CVE-2021-23017
write_files:
  - path: /usr/local/nginx/conf/nginx.conf
    content: |
      user  www-data www-data;
      worker_processes  1;

      events {
          worker_connections  1024;
      }

      http {
          resolver 8.8.8.8 valid=30s;

          server {
              listen       80;
              server_name  localhost;

              location / {
                  proxy_pass http://example.com;
              }
          }
      }

final_message: "NGINX vulnerable version has been installed and is running as a service!"
